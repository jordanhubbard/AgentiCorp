id: bd-017
type: task
title: P2 - Provider/model metrics + dynamic scoring (availability/latency/throughput)
description: |
    Add runtime metrics and a dynamic scoring system to rank provider-model
    candidates.

    Metrics
    - Track per-provider/per-model rolling metrics:
      - success/error rate
      - latency (TTFB if available; otherwise total duration)
      - throughput (tokens/sec when measurable)
      - last_seen_at
    - Persist aggregated metrics in config DB (schema TBD).

    Scoring
    - Compute a score combining:
      - availability/health
      - latency (lower is better)
      - throughput (higher is better)
      - future: dollar cost
    - Expose score in provider state and API responses.

    Instrumentation
    - Capture timing around provider chat completion calls.
    - Update rolling metrics upon each request.

    Acceptance Criteria
    - ✅ Scores exist and update over time based on real request data
    - ✅ Metrics are tracked per-provider (success/error rate, latency, throughput)
    - ✅ Dynamic scoring combines availability + performance
    - ✅ Scores/metrics are visible via Provider API (metrics field)
    - ⚠️  Provider negotiation can use scores (GetScore() method available)
    
    Implementation Summary
    - Added ProviderMetrics struct tracking:
      * Request counters (total/success/failed)
      * Latency stats (avg/min/max)
      * Throughput (tokens/sec)
      * Computed scores (availability/performance/overall)
    - Added Provider.RecordSuccess() and RecordFailure() methods
    - Added Provider.GetScore() for overall score (0-100)
    - Added metrics callback mechanism to Registry
    - Instrumented Registry.SendChatCompletion() to capture timing
    - Wired up metrics recording in AgentiCorp via setupProviderMetrics()
    - Metrics persisted to database via attributes_json field
    - Metrics updates published to event bus
    
    Scoring Formula
    - Availability Score (60% weight): health status * success rate
    - Performance Score (40% weight): 70% latency + 30% throughput
    - Overall Score: 0.6 * availability + 0.4 * performance
    - Uses exponential moving average for rolling metrics
    
status: closed
priority: 2
projectid: ""
assignedto: agent-1768861966-cfo
blockedby: []
blocks: []
relatedto: []
parent: bd-014
children: []
tags:
    - p2
    - scoring
    - metrics
    - providers
    - models
context:
    agent_id: agent-1768861966-cfo
    dispatch_history: '["agent-1768861966-cfo"]'
    last_run_at: "2026-01-20T00:44:56Z"
    last_run_error: 'task execution failed: failed to get completion: failed to send request: Post "http://localhost:8000/v1/chat/completions": dial tcp [::1]:8000: connect: connection refused'
    loop_detected: "false"
    provider_id: bootstrap-local
    redispatch_requested: "false"
    source: user-request
createdat: 0001-01-01T00:00:00Z
updatedat: 2026-01-20T16:52:43Z
closedat: 2026-01-20T16:52:43Z
